name: Build and Release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

jobs:
    build-and-release:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build Extension
              run: npm run build

            - name: Create Signed CRX
              run: |
                  # Generate CRX using Chrome CLI (Native Packing)
                  # This avoids node-library inconsistencies
                  echo "${{ secrets.CRX_PRIVATE_KEY }}" > private_key.pem
                  google-chrome --pack-extension=dist --pack-extension-key=private_key.pem
                  mv dist.crx gear-interactive.crx
                  rm private_key.pem

            - name: Create GitHub Release
              if: startsWith(github.ref, 'refs/tags/')
              uses: softprops/action-gh-release@v2
              with:
                  files: gear-interactive.crx
                  body: "Verified Production Release (CRX Signed) ${{ github.ref_name }}"
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload CRX Artifact for Debugging
              uses: actions/upload-artifact@v4
              with:
                  name: gear-interactive-crx
                  path: gear-interactive.crx

            - name: Upload CRX to Chrome Web Store
              if: startsWith(github.ref, 'refs/tags/')
              env:
                  CLIENT_ID: ${{ secrets.CLIENT_ID }}
                  CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
                  REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
                  EXTENSION_ID: ${{ secrets.EXTENSION_ID }}
              run: |
                  echo "Getting Access Token..."
                  RESPONSE=$(curl -s "https://oauth2.googleapis.com/token" \
                    -d client_id="$CLIENT_ID" \
                    -d client_secret="$CLIENT_SECRET" \
                    -d refresh_token="$REFRESH_TOKEN" \
                    -d grant_type=refresh_token)

                  ACCESS_TOKEN=$(echo "$RESPONSE" | jq -r .access_token)

                  if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" == "null" ]; then
                    echo "Failed to get access token"
                    echo "$RESPONSE"
                    exit 1
                  fi

                  echo "Uploading CRX..."
                  HTTP_CODE=$(curl -s -o response.json -w "%{http_code}" \
                       -H "Authorization: Bearer $ACCESS_TOKEN" \
                       -H "x-goog-api-version: 2" \
                       -H "Content-Type: application/x-chrome-extension" \
                       -X PUT \
                       -T gear-interactive.crx \
                       "https://www.googleapis.com/upload/chromewebstore/v1.1/items/$EXTENSION_ID")

                  echo "Upload Response Code: $HTTP_CODE"
                  cat response.json

                  if [ "$HTTP_CODE" -ne 200 ]; then
                    echo "Upload failed with HTTP $HTTP_CODE"
                    exit 1
                  fi

                  UPLOAD_STATE=$(jq -r .uploadState response.json)
                  if [ "$UPLOAD_STATE" == "FAILURE" ] || [ "$UPLOAD_STATE" == "null" ]; then
                    echo "Upload failed (JSON state: $UPLOAD_STATE)"
                    exit 1
                  fi

                  echo "Publishing..."
                  HTTP_CODE_PUB=$(curl -s -o publish_response.json -w "%{http_code}" \
                       -H "Authorization: Bearer $ACCESS_TOKEN" \
                       -H "x-goog-api-version: 2" \
                       -H "Content-Length: 0" \
                       -X POST \
                       "https://www.googleapis.com/chromewebstore/v1.1/items/$EXTENSION_ID/publish")
                       
                  echo "Publish Response Code: $HTTP_CODE_PUB"
                  cat publish_response.json

                  if [ "$HTTP_CODE_PUB" -ne 200 ]; then
                     echo "Publish failed"
                     exit 1
                  fi
