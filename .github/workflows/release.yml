name: Build and Release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

jobs:
    build-and-release:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build Extension
              run: npm run build

            - name: Create Signed CRX
              run: |
                  npm install -g crx3

                  echo "${{ secrets.CRX_PRIVATE_KEY }}" > private_key.pem

                  crx3 -p private_key.pem -o gear-interactive.crx dist/

                  rm private_key.pem

            - name: Create GitHub Release
              if: startsWith(github.ref, 'refs/tags/')
              uses: softprops/action-gh-release@v2
              with:
                  files: gear-interactive.crx
                  body: "Verified Production Release (CRX Signed) ${{ github.ref_name }}"
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload to Chrome Web Store
              if: startsWith(github.ref, 'refs/tags/')
              uses: mnao305/chrome-extension-upload@v5.0.0
              with:
                  file-path: gear-interactive.crx
                  extension-id: ${{ secrets.EXTENSION_ID }}
                  client-id: ${{ secrets.CLIENT_ID }}
                  client-secret: ${{ secrets.CLIENT_SECRET }}
                  refresh-token: ${{ secrets.REFRESH_TOKEN }}
