name: Build and Release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

jobs:
    build-and-release:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build Extension
              run: npm run build

            - name: Create Signed CRX
              run: |
                  # Generate CRX using Chrome CLI (Native Packing)
                  # This avoids node-library inconsistencies
                  echo "${{ secrets.CRX_PRIVATE_KEY }}" > private_key.pem
                  # Generate CRX using the traditional RSA key
                  # cd into dist to ensure root of CRX is the content of dist
                  cd dist
                  crx3 -p ../private_key.pem -o ../gear-interactive.crx .
                  cd ..
                  rm private_key.pem

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  files: gear-interactive.crx
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload ZIP Artifact for Debugging
              uses: actions/upload-artifact@v4
              with:
                  name: gear-interactive-zip
                  path: gear-interactive.zip

            - name: Upload CRX to Chrome Web Store
              if: startsWith(github.ref, 'refs/tags/')
              env:
                  CLIENT_ID: ${{ secrets.CLIENT_ID }}
                  CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
                  REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
                  EXTENSION_ID: ${{ secrets.EXTENSION_ID }}
              run: |
                  # Get Access Token
                  ACCESS_TOKEN=$(curl -s "https://oauth2.googleapis.com/token" \
                    -d client_id="$CLIENT_ID" \
                    -d client_secret="$CLIENT_SECRET" \
                    -d refresh_token="$REFRESH_TOKEN" \
                    -d grant_type=refresh_token | jq -r .access_token)

                  if [ "$ACCESS_TOKEN" == "null" ]; then
                    echo "Failed to get Access Token"
                    exit 1
                  fi

                  echo "Getting Access Token... Done"
                  echo "Uploading CRX..."

                  # Upload CRX
                  # Requires Content-Type: application/x-chrome-extension
                  HTTP_CODE=$(curl -s -o response.json -w "%{http_code}" \
                       -H "Authorization: Bearer $ACCESS_TOKEN" \
                       -H "x-goog-api-version: 2" \
                       -H "Content-Type: application/x-chrome-extension" \
                       -X PUT \
                       -T gear-interactive.crx \
                       "https://www.googleapis.com/upload/chromewebstore/v1.1/items/$EXTENSION_ID")

                  echo "Upload Response Code: $HTTP_CODE"
                  cat response.json

                  if [ "$HTTP_CODE" -ne 200 ]; then
                    echo "Upload failed with HTTP $HTTP_CODE"
                    # Check for specific "uploadState":"FAILURE" which indicates a logic error despite 200 OK sometimes
                    if grep -q "FAILURE" response.json; then
                      echo "API reported FAILURE state"
                      exit 1
                    fi
                    exit 1
                  fi

                  # Double check success state in JSON
                  if grep -q "SUCCESS" response.json; then
                    echo "Upload SUCCESS"
                  else
                    # Sometimes simple updates don't clearly state SUCCESS but aren't FAILURES.
                    # If we got 200 and no FAILURE, we assume success.
                    echo "Upload completed (Status 200)"
                  fi

                  # Publish
                  echo "Publishing..."
                  PUBLISH_CODE=$(curl -s -o publish_response.json -w "%{http_code}" \
                       -H "Authorization: Bearer $ACCESS_TOKEN" \
                       -H "x-goog-api-version: 2" \
                       -H "Content-Length: 0" \
                       -X POST \
                       "https://www.googleapis.com/chromewebstore/v1.1/items/$EXTENSION_ID/publish")

                  echo "Publish Response Code: $PUBLISH_CODE"
                  cat publish_response.json

                  if [ "$PUBLISH_CODE" -ne 200 ]; then
                    echo "Publish failed"
                    exit 1
                  fi
